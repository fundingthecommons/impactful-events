name: Form Testing & Quality Assurance

on:
  pull_request:
    paths:
      - 'src/app/_components/DynamicApplicationForm.tsx'
      - 'src/app/_components/EditableApplicationForm.tsx'
      - 'src/app/_components/ApplicationCompletionStatus.tsx'
      - 'src/app/_components/ApplicationProgressIndicator.tsx'
      - 'src/app/_components/__tests__/**'
      - 'src/server/api/routers/application.ts'
  push:
    branches: [main]
    paths:
      - 'src/app/_components/DynamicApplicationForm.tsx'
      - 'src/app/_components/EditableApplicationForm.tsx' 
      - 'src/app/_components/__tests__/**'

jobs:
  form-tests:
    name: Form Component Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run Form Tests
        run: |
          echo "üß™ Running form test suite..."
          bun run test:form

      - name: Run Form Validation Tests  
        run: |
          echo "üîß Running validation logic tests..."
          bun run test:form-validation

      - name: TypeScript Check
        run: |
          echo "üìã Running TypeScript validation..."
          bun run typecheck

      - name: Lint Form Components
        run: |
          echo "üîç Running code quality checks..."
          SKIP_ENV_VALIDATION=1 bun run lint src/app/_components/DynamicApplicationForm.tsx

      - name: Test Results Summary
        if: always()
        run: |
          echo "## Form Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "### Core Form Logic Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Conditional field detection" >> $GITHUB_STEP_SUMMARY
          echo "- Missing fields calculation" >> $GITHUB_STEP_SUMMARY  
          echo "- Form completion validation" >> $GITHUB_STEP_SUMMARY
          echo "- Social media handle conversion" >> $GITHUB_STEP_SUMMARY
          echo "- Edge case handling" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Logic Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Client-side validation accuracy" >> $GITHUB_STEP_SUMMARY
          echo "- Conditional field pattern matching" >> $GITHUB_STEP_SUMMARY
          echo "- Missing field identification" >> $GITHUB_STEP_SUMMARY
          echo "- Form state management" >> $GITHUB_STEP_SUMMARY

  form-quality-check:
    name: Form Quality Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Form Component Analysis
        run: |
          echo "üîç Analyzing form component architecture..."
          echo "Checking for:"
          echo "- Infinite re-render risks"
          echo "- State synchronization issues"  
          echo "- Performance anti-patterns"
          echo "- Data flow consistency"
          echo ""
          echo "Form components modified in this PR should follow:"
          echo "- Hybrid data flow pattern (server hydration ‚Üí frontend authority ‚Üí server persistence)"
          echo "- Client-side validation during editing"
          echo "- onBlur saving for text inputs"
          echo "- Maximum 2 useEffects per component"
          echo ""
          echo "See docs/FORM_TESTING.md for complete testing guidelines."

      - name: Comment PR with Testing Info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üß™ Form Testing Results
              
              Form component changes detected! The automated test suite has run to prevent:
              
              ### Issues Previously Encountered
              - ‚úÖ **Infinite re-render loops** causing browser hanging
              - ‚úÖ **Data disappearing** during auto-save operations
              - ‚úÖ **Scroll targeting wrong fields** (conditional vs required)
              - ‚úÖ **Frontend-backend sync** mismatches
              
              ### Tests Executed
              - **Core Logic Tests**: Validates form completion and missing fields calculation
              - **Validation Tests**: Ensures conditional field handling works correctly
              - **Code Quality**: TypeScript and ESLint validation
              
              ### Testing Commands
              \`\`\`bash
              # Test locally
              bun run test:form
              bun run test:form-validation
              
              # Comprehensive testing
              ./scripts/test-form.sh
              \`\`\`
              
              See \`docs/FORM_TESTING.md\` for complete testing guidelines.`
            })